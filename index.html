<!DOCTYPE html>
<html>
    <head>
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>Tonalite Client - Control Board</title>
        <link href="/static/css/nouislider.min.css" rel="stylesheet">
        <link href="/static/css/style.css" rel="stylesheet">
        <script src="/static/js/jquery-3.2.1.min.js"></script>
        <script src="/static/js/socket.io.js"></script>
        <script src="/static/js/isMobile.min.js"></script>
        <script src="/static/js/nouislider.min.js"></script>
        <script src="/static/js/wNumb.js"></script>
        <script defer src="/static/js/packs/solid.min.js"></script>
        <script defer src="/static/js/fontawesome.min.js"></script>
        <script>
            (function () {
                var MOBILE_SITE = '/mobile';
                if (isMobile.any) {
                    document.location = MOBILE_SITE;
                }
            })();
        </script>
        <script type="text/javascript" charset="utf-8">
        function openTab(evt, tabName) {
            var i, tabcontent, tablinks;

            tabcontent = document.getElementsByClassName("tabcontent");
            for (i = 0; i < tabcontent.length; i++) {
                tabcontent[i].style.display = "none";
            }

            tablinks = document.getElementsByClassName("tablinks");
            for (i = 0; i < tablinks.length; i++) {
                tablinks[i].className = tablinks[i].className.replace(" active", "");
            }

            if (tabName == "slidercues") {
                document.getElementById(tabName).style.display = "inline";
            } else {
                document.getElementById(tabName).style.display = "flex";
            }
            document.title = "Tonalite Client - " + tabName.charAt(0).toUpperCase() + tabName.slice(1)
            evt.currentTarget.className += " active";
        }
        $(document).ready(function(){
            document.getElementById("channelsTabBtn").click();
            namespace = '/tonalite';

            for(var i = 0; i <= 47; i++) {
                $("#channels").append("<div class=\"tombstone\"><h1 class=\"subtitle channelNum\">"+(i+1)+"</h1> \
                                       <input type=\"number\" class=\"channelVal\" min=\"0\" max=\"255\" value=\"0\" id=\"cval-"+(i+1)+"\"></div>");
                $("#sliders").append("<div><div class=\"sliders\" id=\"sliderchan-"+(i+1)+"\"></div><br><span class=\"slidernum\">"+(i+1)+"</span></div>");                
            }

            var sliders = document.getElementsByClassName('sliders');
            
            for ( var i = 0; i < sliders.length; i++ ) {
            
                noUiSlider.create(sliders[i], {
                    start: 0,
                    connect: [true, false],
                    direction: 'rtl',
                    orientation: "vertical",
                    range: {
                        'min': 0,
                        'max': 255
                    },
                    format: wNumb({
                        decimals: 0,
                    })
                });

                sliders[i].noUiSlider.on('end', updateChan);
            }

            function updateChan() {
                var allValues = [];
                
                for (var i = 0; i < sliders.length; i++) {
                    allValues.push(sliders[i].noUiSlider.get());
                };

                socket.emit('update chans', {chans: allValues});
            }

            var socket = io.connect('http://' + document.domain + ':' + location.port + namespace);

            socket.on('my response', function(msg) {
                /*console.log('Received: ' + msg.data);*/
                for(var i = 0; i <= 48; i++) {
                    $("#cval-"+(i+1)).val(msg.data[i]);
                };

                for (var i = 0; i < sliders.length; i++) {
                    sliders[i].noUiSlider.set(msg.data[i])
                };

                $("#cues").empty();
                for (var i = 0; i < msg.cues.length; i++) {
                    if (i == msg.ccue) {
                        $("#cues").append("<div class=\"cue active\" cuenumber=\""+i+"\">"+(i+1)+"</div>");
                    } else {
                        $("#cues").append("<div class=\"cue\" cuenumber=\""+i+"\">"+(i+1)+"</div>");
                    }
                };
            });

            socket.on('update show', function(msg) {
                $('#save_show_name').val(msg.name);
                $('#save_show_author').val(msg.author);
                $('#save_show_copyright').val(msg.copyright);
            });

            $('form#command').submit(function(event) {
                socket.emit('command message', {data: $('#command_data').val()});
                $('#command_data').val("");
                return false;
            });

            $('form#open_show').submit(function(event) {
                socket.emit('open show', {name: $('#open_show_name').val()});
                $('#open_show_name').val("");
                return false;
            });

            $('form#save_show').submit(function(event) {
                if (confirm('Are you sure you want to save this show? If another show with the same name exists, it will be overwritten.')) {
                    socket.emit('save show', {name: $('#save_show_name').val(), author: $('#save_show_author').val(), copyright: $('#save_show_copyright').val()});
                    $('#save_show_name').val("");
                    $('#save_show_author').val("");
                    $('#save_show_copyright').val("");
                }
                return false;
            });

            $('.channelVal').change(function(event) {
                socket.emit('update chan', {val: $("#"+this.id).val(), chan: this.id});
                return false;
            });

            $('.keypad-btn').click(function(event) {
                $('#command_data').val($('#command_data').val() + $(this).attr('inputVal'));
            });
            $(document).on('click', '.cue', function(event) {
                console.log("q "+$(this).attr('cuenumber')+" g");
                socket.emit('command message', {data: "q n"});
                return false;
            });
        });
        </script>
    </head>
    <body>
        <div class="tab">
            <button class="tablinks btn" onclick="openTab(event, 'channels')" id="channelsTabBtn"><i class="fa fa-list-alt"></i> Channels</button>
            <button class="tablinks btn" onclick="openTab(event, 'keypad')"><i class="fa fa-keyboard"></i> Keypad</button>
            <button class="tablinks btn" onclick="openTab(event, 'slidercues')"><i class="fa fa-sliders-v-square"></i> Sliders and Cues</button>
            <button class="tablinks btn" onclick="openTab(event, 'show')"><i class="fa fa-cogs"></i> Show Settings</button>
        </div>
        <div style="clear: both;"></div>
        <br>
        <div id="channels" class="tabcontent"></div>
        <div id="keypad" class="tabcontent">
            <div>
                <div class="helpers">
                    <button class="keypad-btn btn btn-secondary" inputVal="c "><i class="fa fa-cube"></i> Channel</button>
                    <button class="keypad-btn btn btn-secondary" inputVal="q "><i class="fa fa-list"></i> Cue</button>
                    <button class="keypad-btn btn btn-secondary" inputVal=" g"><i class="fa fa-hand-point-right"></i> Go</button>
                    <button class="keypad-btn btn btn-secondary" inputVal=" s"><i class="fa fa-stop-circle"></i> Stop</button>
                </div>
                <div class="helpers">
                    <button class="keypad-btn btn btn-secondary" inputVal=" r"><i class="fa fa-circle"></i> Record</button>
                    <button class="keypad-btn btn btn-secondary" inputVal=" t "><i class="fa fa-stopwatch"></i> Time</button>
                    <button class="keypad-btn btn btn-secondary" inputVal=" n"><i class="fa fa-arrow-alt-to-right"></i> Next</button>
                    <button class="keypad-btn btn btn-secondary" inputVal=" l"><i class="fa fa-arrow-alt-from-right"></i> Last</button>
                </div>
            </div>
            <div>
                <div class="numbers">
                    <div>
                        <button class="keypad-btn btn btn-primary" inputVal="1">1</button>
                        <button class="keypad-btn btn btn-primary" inputVal="2">2</button>
                        <button class="keypad-btn btn btn-primary" inputVal="3">3</button>
                    </div>
                    <div>
                        <button class="keypad-btn btn btn-primary" inputVal="4">4</button>
                        <button class="keypad-btn btn btn-primary" inputVal="5">5</button>
                        <button class="keypad-btn btn btn-primary" inputVal="6">6</button>
                    </div>
                    <div>
                        <button class="keypad-btn btn btn-primary" inputVal="7">7</button>
                        <button class="keypad-btn btn btn-primary" inputVal="8">8</button>
                        <button class="keypad-btn btn btn-primary" inputVal="9">9</button>
                    </div>
                    <div>
                        <button class="keypad-btn btn btn-primary" inputVal="d"><i class="fa fa-chevron-double-up"></i></button>
                        <button class="keypad-btn btn btn-primary" inputVal="0">0</button>
                        <button class="keypad-btn btn btn-primary" inputVal="b"><i class="fa fa-chevron-double-down"></i></button>
                    </div>
                    <div>
                        <button class="keypad-btn btn btn-secondary" inputVal=" a "><i class="fa fa-at"></i> At</button>
                        <button class="keypad-btn btn btn-secondary" inputVal="+"><i class="fa fa-plus-circle"></i> And</button>
                        <button class="keypad-btn btn btn-secondary" inputVal="-" style="padding: 1em 4em"><i class="fa fa-arrows-h"></i> Through</button>
                    </div>
                </div>
                <div class="commandBox">
                    <form id="command" method="POST" action='#'>
                        <input type="text" name="command_data" id="command_data" placeholder="Command here">
                        <button type="submit" class="btn btn-secondary" id="submit_btn"><i class="fa fa-play-circle"></i> Please</button>
                        <button type="reset" class="btn btn-danger" id="clr_btn"><i class="fa fa-window-close"></i> Clr</button>
                    </form>
                </div>
            </div>
        </div>
        <div id="slidercues" class="tabcontent">
            <div id="sliders"></div>
            <div id="cues"></div>
        </div>
        <div id="show" class="tabcontent">
            <div class="helpers">
                <h1 class="subtitle">Open Show</h1>
                <form id="open_show" method="POST" action='#'>
                    <input type="text" id="open_show_name" placeholder="Name">
                    <br>
                    <input type="submit" class="btn btn-primary" value="Open">
                </form>
                <br>
            </div>
            <div class="helpers">
                <h1 class="subtitle">Save Show</h1>
                <form id="save_show" method="POST" action='#'>
                    <input type="text" id="save_show_name" placeholder="Name">
                    <br>
                    <input type="text" id="save_show_author" placeholder="Author">
                    <br>
                    <input type="text" id="save_show_copyright" placeholder="Copyright">
                    <br>
                    <input type="submit" class="btn btn-secondary" value="Save">
                    <input type="reset" class="btn btn-danger" value="Clear">
                </form>
            </div>
        </div>
    </body>
</html>